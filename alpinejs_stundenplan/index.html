<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.2.2/dist/alpine.min.js" defer></script>
  <title>Alpine.js Stundenplan</title>
</head>

<body class="h-screen bg-gray-200">

  <main class="container p-10 mx-auto" x-data="data()" x-init="init($watch)">

    <label class="block">
      <span class="font-semibold">Beruf</span>
      <select class="block w-full shadow form-select" @input="handelJobSelect($event)">
        <option :value="null" default disabled>Beruf W채hlen</option>
        <template x-for="beruf in berufe">
          <option :key="beruf.beruf_id" :value="beruf.beruf_id" :selected="beruf.beruf_id === jobId" x-text="beruf.beruf_name"></option>
        </template>
      </select>
    </label>

    <div x-show.transition="jobId">
      <div class="hidden sm:block">
        <div class="py-5">
          <hr class="h-px text-gray-500" />
        </div>
      </div>
      <label class="block">
        <span class="font-semibold">Klasse</span>
        <select class="block w-full shadow form-select" @input="handelClassSelect($event)">
          <option :value="null" :selected="classId === ''" default disabled>Klasse W채hlen</option>
          <template x-for="klasse in klassen">
            <option :value="klasse.klasse_id" :selected="klasse.klasse_id === classId" x-text="klasse.klasse_name"></option>
          </template>
        </select>
      </label>
    </div>

    <div x-show.transition="classId">
      <div class="hidden sm:block">
        <div class="py-5">
          <hr class="h-px text-gray-500" />
        </div>
      </div>
      <div class="flex my-4 rounded shadow md:my-0 md:mb-4">
        <button @click="subtractWeek()"
          class="w-2/5 px-4 py-3 bg-white rounded-l hover:bg-blue-500 hover:text-gray-100">
          &lt;
        </button>
        <div x-text="`Woche ${week}`" class="block w-full p-3 text-center bg-white select-none">
        </div>
        <button @click="addWeek()" class="w-2/5 px-4 py-3 bg-white rounded-r hover:bg-blue-500 hover:text-gray-100">
          &gt;
        </button>
      </div>
    </div>

    <div x-show="!loadingLectures">
      <div x-show="lectures.length">
        <div class="transition-all transform">
          <table class="hidden w-full bg-gray-100 rounded shadow md:table">
            <thead class="border-4 border-transparent rounded-t">
              <tr class="">
                <th class="px-4 text-left">Wochentag/Datum</th>
                <th class="px-2">Von</th>
                <th class="px-2">Bis</th>
                <th class="px-4 text-left">Fach</th>
                <th class="px-4 text-left">Lehrer</th>
                <th class="px-4 text-left">Zimmer</th>
                <th class="px-4 text-left">Bemerkung</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="lecture in lectures">
                <tr class="h-12 text-sm border-b border-gray-200" :key="lecture.tafel_id">
                  <td class="px-4" x-text="toHumanReadableDate(lecture.tafel_datum)"></td>
                  <td class="px-2 text-center" x-text="toShortTime(lecture.tafel_von)"></td>
                  <td class="px-2 text-center" x-text="toShortTime(lecture.tafel_bis)"></td>
                  <td class="px-4" x-text="lecture.tafel_longfach"></td>
                  <td class="px-4" x-text="lecture.tafel_lehrer"></td>
                  <td class="px-4" x-text="lecture.tafel_raum"></td>
                  <td class="px-4" x-text="lecture.tafel_kommentar"></td>
                </tr>
              </template>
            </tbody>
          </table>
          <ul class="mt-4 overflow-hidden bg-white rounded shadow md:hidden">
            <template x-for="lecture in lectures" :key="`${lecture.tafel_id}_mobile`">
              <li class="p-4 border-b border-gray-200">
                <div>
                  <span class="block text-sm font-semibold">Datum</span>
                  <span x-text="toHumanReadableDate(lecture.tafel_datum)"></span>
                </div>
                <div>
                  <span class="block text-sm font-semibold">Von/Bis</span>
                  <time>
                    <span x-text="toShortTime(lecture.tafel_von)"></span>
                    -
                    <span x-text="toShortTime(lecture.tafel_bis)"></span>
                  </time>
                </div>
                <div>
                  <span class="block text-sm font-semibold">Fach</span>
                  <span x-text="lecture.tafel_longfach"></span>
                </div>
                <div>
                  <span class="block text-sm font-semibold">Lehrer</span>
                  <span x-text="lecture.tafel_lehrer"></span>
                </div>
                <div>
                  <span class="block text-sm font-semibold">Raum</span>
                  <span x-text="lecture.tafel_raum"></span>
                </div>
                <div x-show="lecture.tafel_kommentar">
                  <span class="block text-sm font-semibold">Bemerkung</span>
                  <span x-text="lecture.tafel_kommentar"></span>
                </div>
              </li>
            </template>
          </ul>
        </div>
      </div>

      <div x-show="!lectures.length">
        <div class="p-4 text-center transition-all transform bg-white rounded shadow">
          <p class="font-semibold text-gray-800">
            Es liegt kein Stundenplan f체r den gew체nschten Zeitraum vor.
          </p>
        </div>
      </div>
    </div>
  </main>


  <script>
    const dateCalc = createWeekCalculator()

    function data() {
      return {
        jobId: null,
        classId: null,
        week: dateCalc.getWeekString(),
        berufe: [],
        klassen: [],
        lectures: [],
        loadingClass: true,
        loadingLectures: true,
        init() {
          this.useJobs()
          this.useClasses()
          this.useLectures()
          this.usePersistedState('jobId', true)
          this.usePersistedState('classId')
        },
        usePersistedState(key, destructive = false) {
          let urlKey = new URLSearchParams(window.location.search).get(key)
          this[key] = urlKey || localStorage.getItem(key) || ''

          this.$watch(key, (state) => {
            if (state !== '' && state !== null) {
              let url
              if (destructive) {
                localStorage.clear()
                url = new URLSearchParams('')
              } else {
                url = new URLSearchParams(window.location.search)
              }
              localStorage.setItem(key, state)
              url.set(key, state)
              window.history.replaceState(null, 'search', `?${url.toString()}`)
            }
          })
        },
        handelJobSelect($event) {
          this.classId = ''
          this.jobId = $event.target.value
        },
        handelClassSelect($event) {
          this.classId = $event.target.value
        },
        async useJobs() {
          this.berufe = await getJobs()
        },
        useClasses() {
          this.$watch('jobId', async () => {
            if (this.jobId !== '' && this.jobId !== null) {
              this.loadingClass = true
              this.klassen = await getClasses(this.jobId)
              this.loadingClass = false
            }
          })
        },
        useLectures() {
          const fetch = async () => {
            if (this.classId !== '' && this.classId !== null) {
              this.loadingLectures = true
              lectures = await getLectures(this.classId, this.week)
              this.lectures = lectures
              this.loadingLectures = false
              console.log(this.loadingLectures)
            }
          }
          this.$watch('classId', fetch)
          this.$watch('week', fetch)
          this.$watch('lectures', (val) => console.log(val))
        },
        toHumanReadableDate(date) {
          return new Date(date).toLocaleDateString('de-CH', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
          })
        },
        toShortTime(time) {
          return time.slice(0, 5)
        },
        addWeek() {
          dateCalc.addWeek()
          this.week = dateCalc.getWeekString()
        },
        subtractWeek() {
          dateCalc.subtractWeek()
          this.week = dateCalc.getWeekString()
        }
      }
    }

    function createWeekCalculator(initialDate) {
        let date = initialDate ? new Date(initialDate) : new Date()
        const WEEK = 604800000
        const DAY = 86400000
        /**
         * Private Function for calculating the Week
         * @param {Date} date
         */
        const _getWeekAndYearString = (date) => {
          // Temporary date to prevent mutation
          const tempDate = new Date(date.valueOf())
          tempDate.setHours(0,0,0,0)
          // Set to the nearest Thursday (current date + 4 - current day number)
          tempDate.setDate(tempDate.getDate() + 4 - (tempDate.getDay() || 7))
          // Get first day of year
          const yearStart = new Date(tempDate.getFullYear(),0,1)
          // Calculate full weeks to nearest Thursday
          const weekNumber = Math.ceil((((tempDate - yearStart) / DAY) + 1)/7)
          // Return ISO week number and Year
          return `${weekNumber}-${yearStart.getFullYear()}`
        }

      return {
        getWeekString() {
          return _getWeekAndYearString(date)
        },
        addWeek() {
          const nextWeek = date.getTime() + WEEK
          date.setTime(nextWeek)
        },
        subtractWeek() {
          const previousWeek = date.getTime() - WEEK
          date.setTime(previousWeek)
        },
        reset() {
          date = new Date()
        }
      }
    }

    async function getJobs () {
      data = await fetch(`http://sandbox.gibm.ch/berufe.php?`)
        .then(res => {
        if (res.ok) {
          return res.json()
        }
      })
      return data
    }
    async function getClasses (jobId) {
      data = await fetch(`http://sandbox.gibm.ch/klassen.php?beruf_id=${jobId}`)
        .then(res => {
        if (res.ok) {
          return res.json()
        }
      })
      return data
    }
    async function getLectures (classId, week) {
      data = await fetch(`http://sandbox.gibm.ch/tafel.php?klasse_id=${classId}&woche=${week}`)
        .then(res => {
        if (res.ok) {
          return res.json()
        }
      })
      return data
    }

  </script>
</body>

</html>
